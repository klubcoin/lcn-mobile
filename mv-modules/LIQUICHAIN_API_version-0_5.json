[ {
  "active" : true,
  "code" : "LIQUICHAIN_API",
  "description" : "Liquichain json-rpc API",
  "license" : "GPL",
  "currentVersion" : "0.5",
  "transient" : true,
  "codeOnly" : false,
  "inDraft" : true,
  "moduleItems" : [ {
    "dtoClassName" : "org.meveo.api.dto.technicalservice.endpoint.EndpointDto",
    "dtoData" : {
      "code" : "jsonrpc",
      "description" : "eth json rpc api",
      "secured" : false,
      "checkPathParams" : false,
      "serviceCode" : "io.liquichain.api.rpc.EthApiScript",
      "synchronous" : true,
      "method" : "POST",
      "parameterMappings" : [ ],
      "pathParameters" : [ ],
      "roles" : [ ],
      "returnedVariableName" : "result",
      "serializeResult" : false
    }
  }, {
    "dtoClassName" : "org.meveo.api.dto.ScriptInstanceDto",
    "dtoData" : {
      "active" : true,
      "code" : "io.liquichain.api.rpc.EthApiScript",
      "description" : "eth rpc api",
      "inputs" : [ {
        "name" : "projectId",
        "type" : "String",
        "description" : null
      } ],
      "outputs" : [ {
        "name" : "result",
        "type" : "String",
        "description" : null
      } ],
      "generateOutputs" : false,
      "type" : "JAVA",
      "transactionType" : "SAME",
      "script" : "package io.liquichain.api.rpc;\r\n\r\nimport java.util.Map;\r\nimport java.util.List;\r\nimport java.util.Arrays;\r\nimport java.util.ArrayList;\r\nimport java.math.BigInteger;\r\nimport java.io.IOException;\r\nimport org.meveo.service.script.Script;\r\nimport org.meveo.admin.exception.BusinessException;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\nimport java.math.BigInteger;\r\nimport org.meveo.model.customEntities.Wallet;\r\nimport org.meveo.model.customEntities.Transaction;\r\nimport org.meveo.model.storage.Repository;\r\nimport org.meveo.service.storage.RepositoryService;\r\nimport org.meveo.api.persistence.CrossStorageApi;\r\nimport org.meveo.api.exception.EntityDoesNotExistsException;\r\nimport com.fasterxml.jackson.databind.ObjectMapper;\r\n\r\nimport org.web3j.crypto.*;\r\n\r\npublic class EthApiScript extends Script {\r\n\r\n    private static final Logger log = LoggerFactory.getLogger(EthApiScript.class);\r\n  \r\n    private long chainId=76;\r\n\r\n    private String result;\r\n\r\n    private int networkId = 7;\r\n\r\n    private int blockHeight = 1662;\r\n\r\n    private BigInteger balance = new BigInteger(\"999965000000000000000\");\r\n\r\n    private String exampleBlock = \"{\" + \"\\\"difficulty\\\":\\\"0x5\\\",\" + \"\\\"extraData\\\":\\\"0xd58301090083626f7286676f312e3133856c696e75780000000000000000000021c9effaf6549e725463c7877ddebe9a2916e03228624e4bfd1e3f811da792772b54d9e4eb793c54afb4a29f014846736755043e4778999046d0577c6e57e72100\\\",\" + \"\\\"gasLimit\\\":\\\"0xe984c2\\\",\" + \"\\\"gasUsed\\\":\\\"0x0\\\",\" + \"\\\"hash\\\":\\\"0xaa14340feb15e26bc354bb839b2aa41cc7984676249c155ac5e4d281a8d08809\\\",\" + \"\\\"logsBloom\\\":\\\"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\\\",\" + \"\\\"miner\\\":\\\"0x0000000000000000000000000000000000000000\\\",\" + \"\\\"mixHash\\\":\\\"0x0000000000000000000000000000000000000000000000000000000000000000\\\",\" + \"\\\"nonce\\\":\\\"0x0000000000000000\\\",\" + \"\\\"number\\\":\\\"0x1b4\\\",\" + \"\\\"parentHash\\\":\\\"0xc8ccb81f484a428a3a1669d611f55f880b362b612f726711947d98f5bc5af573\\\",\" + \"\\\"receiptsRoot\\\":\\\"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421\\\",\" + \"\\\"sha3Uncles\\\":\\\"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347\\\",\" + \"\\\"size\\\":\\\"0x260\\\",\" + \"\\\"stateRoot\\\":\\\"0xffcb834d62706995e9e7bf10cc9a9e42a82fea998d59b3a5cfad8975dbfe3f87\\\",\" + \"\\\"timestamp\\\":\\\"0x5ed9a43f\\\",\" + \"\\\"totalDifficulty\\\":\\\"0x881\\\",\" + \"\\\"transactions\\\":[\" + \"],\" + \"\\\"transactionsRoot\\\":\\\"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421\\\",\" + \"\\\"uncles\\\":[  \" + \"]}\";\r\n  \r\n  \tprivate CrossStorageApi crossStorageApi = getCDIBean(CrossStorageApi.class);\r\n    private RepositoryService repositoryService = getCDIBean(RepositoryService.class);\r\n    private Repository defaultRepo = repositoryService.findDefaultRepository();\r\n\r\n  \tprivate String projectId;\r\n  \r\n    public String getResult() {\r\n        return result;\r\n    }\r\n\r\n    @Override\r\n    public void execute(Map<String, Object> parameters) throws BusinessException {\r\n      \t//log.info(\"projectId : {}\", projectId);\r\n        log.info(\"parameters:{}\", parameters);\r\n        String method = \"\"+ parameters.get(\"method\");\r\n        String requestId = \"\"+ parameters.get(\"id\");\r\n        switch(method) {\r\n            case \"eth_chainId\":\r\n                result = createResponse(requestId, \"0x4c\");\r\n                break;\r\n            case \"web3_clientVersion\":\r\n                result = createResponse(requestId, \"liquichainCentral\");\r\n                break;\r\n            case \"net_version\":\r\n                result = createResponse(requestId, \"\" + networkId);\r\n                break;\r\n            case \"eth_blockNumber\":\r\n                result = createResponse(requestId, \"0x\"+Integer.toHexString(blockHeight));\r\n                break;\r\n            case \"eth_getBalance\":\r\n                log.info(\"params={}\", parameters.get(\"params\"));\r\n                ArrayList<String> params = (ArrayList<String>)parameters.get(\"params\");\r\n                String hash = params.get(0);\r\n            \tif(hash.startsWith(\"0x\")){\r\n                  hash=hash.substring(2);\r\n            \t}\r\n                result = getBalance(requestId,hash);\r\n                break;\r\n          case \"eth_getBlockByNumber\":\r\n                result = createResponse(requestId, exampleBlock);\r\n                break;\r\n          case \"eth_gasPrice\":\r\n                result = createResponse(requestId, \"0x0\");\r\n                break;\r\n          case \"eth_sendRawTransaction\":\r\n                log.info(\"received transaction : params={}\", parameters.get(\"params\"));\r\n                ArrayList<String> params2 = (ArrayList<String>)parameters.get(\"params\");\r\n                String transacEncoded = params2.get(0);\r\n                result = processTransaction(requestId,transacEncoded) ;\r\n                break;\r\n          case \"eth_getTransactionByHash\":\r\n               ArrayList<String> params3 = (ArrayList<String>)parameters.get(\"params\");\r\n               String hash2 = params3.get(0);\r\n               result = getTransactionByHash(requestId,hash2);\r\n               break;\r\n        }\r\n    }\r\n\r\n    public static String hex(byte[] bytes) {\r\n        StringBuilder result = new StringBuilder();\r\n        for (byte aByte : bytes) {\r\n            result.append(String.format(\"%02x\", aByte));\r\n        }\r\n        return result.toString();\r\n    }\r\n  \r\n    private String toBigHex(String i){\r\n       return \"0x\"+new BigInteger(i).toString(16);\r\n    }\r\n  \r\n    private String getTransactionByHash(String requestId,String hash){\r\n       try {\r\n            log.info(\"lookup transaction hesHash={}\",hash.substring(2));\r\n            Transaction transac = crossStorageApi.find(defaultRepo, Transaction.class).by(\"hexHash\", hash.substring(2)).getResult();\r\n         \tString result =\"{\\n\";\r\n            result+=\"\\\"blockHash\\\": \\\"0xb3b20624f8f0f86eb50dd04688409e5cea4bd02d700bf6e79e9384d47d6a5a35\\\",\\n\";\r\n            result+=\"\\\"blockNumber\\\": \\\"0x5bad55\\\",\\n\";\r\n            result+=\"\\\"from\\\": \\\"0x\"+transac.getFromHexHash()+\"\\\",\\n\";\r\n            result+=\"\\\"gas\\\": \\\"0x1d45e\\\",\\n\";\r\n            result+=\"\\\"gasPrice\\\": \\\"0xfa56ea00\\\",\\n\";\r\n            result+=\"\\\"hash\\\": \\\"\"+hash+\"\\\",\\n\";\r\n    \t\tresult+=\"\\\"input\\\": \\\"\\\",\\n\";\r\n    \t\tresult+=\"\\\"nonce\\\": \\\"\"+toBigHex(transac.getNonce())+\"\\\",\\n\";\r\n    \t\tresult+=\"\\\"r\\\": \\\"0x2a378831cf81d99a3f06a18ae1b6ca366817ab4d88a70053c41d7a8f0368e031\\\",\\n\";\r\n    \t\tresult+=\"\\\"s\\\": \\\"0x450d831a05b6e418724436c05c155e0a1b7b921015d0fbc2f667aed709ac4fb5\\\",\\n\";\r\n    \t\tresult+=\"\\\"to\\\": \\\"0x\"+transac.getToHexHash()+\"\\\",\\n\";\r\n    \t\tresult+=\"\\\"transactionIndex\\\": \\\"0x11\\\",\";\r\n    \t\tresult+=\"\\\"v\\\": \\\"0x25\\\",\";\r\n    \t\tresult+=\"\\\"value\\\": \\\"\"+toBigHex(transac.getValue())+\"\\\"\\n\";\r\n            result+=\"}\";\r\n            log.info(\"res={}\"+result);\r\n            return createResponse(requestId, result);\r\n        } catch (Exception e) {\r\n            //e.printStackTrace();\r\n            return createErrorResponse(requestId, \"-32001\", \"Resource not found\");\r\n        }\r\n    }\r\n  \r\n    private String processTransaction(String requestId,String hexTransactionData){\r\n      String result =\"0x0\";\r\n      RawTransaction t = TransactionDecoder.decode(hexTransactionData);\r\n      log.info(\"nonce:{} to:{} , value:{}\",t.getNonce(),t.getTo(),t.getValue() );\r\n      if(t instanceof SignedRawTransaction){\r\n        SignedRawTransaction signedResult = (SignedRawTransaction) t;\r\n        Sign.SignatureData signatureData = signedResult.getSignatureData();\r\n        //byte[] encodedTransaction = TransactionEncoder.encode(t);\r\n        try {\r\n        log.info(\"from:{} chainedId:{}\",signedResult.getFrom(),signedResult.getChainId());\r\n        String hash =  Hash.sha3(hexTransactionData);\r\n        Transaction transac = new Transaction();\r\n        transac.setHexHash(hash.substring(2));\r\n        transac.setFromHexHash(signedResult.getFrom().substring(2));\r\n        transac.setToHexHash(t.getTo().substring(2));\r\n        transac.setNonce(\"\"+t.getNonce());\r\n        transac.setGasPrice(\"\"+t.getGasPrice());\r\n        transac.setGasLimit(\"\"+t.getGasLimit());\r\n        transac.setValue(\"\"+t.getValue());  \r\n        transac.setSignedHash(hexTransactionData);\r\n        transac.setCreationDate(java.time.Instant.now());\r\n        transac.setV(hex(signatureData.getV()));\r\n        transac.setS(hex(signatureData.getS()));\r\n        transac.setR(hex(signatureData.getR()));\r\n        String uuid = crossStorageApi.createOrUpdate(defaultRepo, transac);\r\n        result = hash;\r\n        log.info(\"created transaction with uuid:{}\",uuid);\r\n        BigInteger key = Sign.signedMessageToKey(signedResult.getEncodedTransaction(chainId), signatureData);\r\n        //signedResult.verify(SampleKeys.ADDRESS);\r\n        log.info(\"key:{} \",key);\r\n        } catch(Exception e){\r\n          e.printStackTrace();\r\n        }\r\n      }\r\n      return createResponse(requestId, result);\r\n    }\r\n  \r\n    private String createResponse(String requestId, String result) {\r\n        String res = \"{\\n\";\r\n        res += \"  \\\"id\\\": \" + requestId + \",\\n\";\r\n        res += \"  \\\"jsonrpc\\\": \\\"2.0\\\",\\n\";\r\n       if(result.startsWith(\"{\")){\r\n        res += \"  \\\"result\\\": \" + result + \"\\n\";\r\n       } else {\r\n        res += \"  \\\"result\\\": \\\"\" + result + \"\\\"\\n\";\r\n       }\r\n        res += \"}\";\r\n        //log.info(\"res:{}\", res);\r\n        return res;\r\n    }\r\n  \r\n  \tprivate String createErrorResponse(String requestId, String errorCode, String message) {\r\n        String res = \"{\\n\";\r\n        res += \"  \\\"id\\\": \" + requestId + \",\\n\";\r\n        res += \"  \\\"jsonrpc\\\": \\\"2.0\\\",\\n\";\r\n        res += \"  \\\"error\\\": { \\\"code\\\" : \"+errorCode+\" , \\\"message\\\" : \\\"\" + message + \"\\\"}\\n\";\r\n        res += \"}\";\r\n        log.info(\"err:{}\", res);\r\n        return res;\r\n    }\r\n\r\n    private String getBalance(String requestId, String hash) {\r\n        try {\r\n            Wallet wallet = crossStorageApi.find(defaultRepo, Wallet.class).by(\"hexHash\", hash).getResult();\r\n            return createResponse(requestId, \"0x\"+new BigInteger(wallet.getBalance()).toString(16));\r\n        } catch (Exception e) {\r\n            //e.printStackTrace();\r\n            return createErrorResponse(requestId, \"-32001\", \"Resource not found\");\r\n        }\r\n    }\r\n  \r\n  \tpublic void setProjectId(String projectId){\r\n      this.projectId = projectId;\r\n    }\r\n}\r\n",
      "executionRoles" : [ ],
      "sourcingRoles" : [ ],
      "mavenDependencies" : [ {
        "groupId" : "org.web3j",
        "artifactId" : "core",
        "version" : "4.8.4",
        "coordinates" : "org.web3j:core:4.8.4"
      } ],
      "importScriptInstances" : [ ]
    }
  } ],
  "moduleDependencies" : [ ],
  "moduleFiles" : [ ]
} ]